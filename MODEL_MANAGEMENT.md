# 模型管理功能说明

## 功能概述

为了增强模型管理的灵活性和健壮性，我们重新设计了模型管理系统，让用户完全掌控哪些模型可以在对话中使用。

## 核心改进

### 1. 模型启用机制

**数据模型增强**：
- `isEnabled`: 标记模型是否被用户启用
- `isManuallyAdded`: 标记模型是否手动添加

**规则**：
- 只有被启用的模型才会出现在对话页面的模型选择中
- 用户必须主动勾选或添加模型，才能使用

### 2. 两种添加模型的方式

#### 方式A：从服务商获取（管理按钮）

**操作流程**：
```
服务商详情页 → 点击"管理"按钮 → 从服务商API获取模型列表 → 勾选需要的模型
```

**特点**：
- 自动获取服务商提供的所有模型
- 用户可以勾选/取消勾选任意模型
- 防止模型列表有缺漏

#### 方式B：手动添加（添加按钮）

**操作流程**：
```
服务商详情页 → 点击"添加"按钮 → 输入模型名称 → 保存
```

**特点**：
- 适用于服务商API未列出的模型
- 适用于测试新模型
- 手动添加的模型会标记"手动添加"标签

## 界面设计

### 服务商详情页

```
┌─────────────────────────────────────┐
│  基本信息                            │
│  昵称: OpenAI                        │
│  类型: OpenAI                        │
│  Base URL: https://api.openai.com   │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  模型列表              [管理] [添加] │
│                                      │
│  ✓ gpt-4                            │
│  ✓ gpt-3.5-turbo                    │
│  ✓ my-custom-model (手动添加)       │
│                                      │
│  已启用 3 个模型                     │
└─────────────────────────────────────┘
```

### 管理模型页面

```
┌─────────────────────────────────────┐
│  ← 管理模型                    完成  │
├─────────────────────────────────────┤
│  可用模型                            │
│  ○ gpt-4-turbo                      │
│  ✓ gpt-4                            │
│  ✓ gpt-3.5-turbo                    │
│  ○ gpt-3.5-turbo-16k                │
│                                      │
│  手动添加的模型                      │
│  ✓ my-custom-model (手动添加)       │
│                                      │
│  勾选的模型将出现在对话页面          │
├─────────────────────────────────────┤
│  [从服务商获取]                      │
└─────────────────────────────────────┘
```

### 添加模型页面

```
┌─────────────────────────────────────┐
│  取消  添加模型                 添加 │
├─────────────────────────────────────┤
│  模型信息                            │
│  ┌─────────────────────────────┐   │
│  │ gpt-4-vision-preview        │   │
│  └─────────────────────────────┘   │
│  请输入完整的模型名称                │
│                                      │
│  常见模型名称示例：                  │
│  • OpenAI: gpt-4, gpt-3.5-turbo    │
│  • Anthropic: claude-3-5-sonnet... │
│  • Gemini: gemini-2.0-flash-exp    │
└─────────────────────────────────────┘
```

## 使用流程

### 场景1：首次配置服务商

1. 添加服务商（如OpenAI）
2. 进入服务商详情页
3. 点击"管理"按钮
4. 点击"从服务商获取"
5. 勾选需要的模型（如gpt-4、gpt-3.5-turbo）
6. 点击"完成"
7. 返回对话页面，这些模型现在可以选择了

### 场景2：添加API未列出的模型

1. 进入服务商详情页
2. 点击"添加"按钮
3. 输入模型名称（如 gpt-4-vision-preview）
4. 点击"添加"
5. 模型立即可用，并标记为"手动添加"

### 场景3：管理已有模型

1. 进入服务商详情页
2. 点击"管理"按钮
3. 勾选/取消勾选模型
4. 删除不需要的手动添加模型（左滑）
5. 点击"完成"

## 技术实现

### 数据模型

```swift
@Model
final class ChatModel {
    var modelName: String
    var isEnabled: Bool        // 是否启用
    var isManuallyAdded: Bool  // 是否手动添加
    var provider: APIProvider?
}
```

### 关键逻辑

**模型过滤**：
```swift
// 只显示已启用的模型
let enabledModels = provider.models?.filter { $0.isEnabled } ?? []
```

**模型选择**：
```swift
// 对话页面只能选择已启用的模型
selectedModel = allModels.first { $0.isEnabled }
```

**模型切换**：
```swift
// 切换模型启用状态
model.isEnabled.toggle()
```

## 优势

### 1. 完全的用户控制
- 用户决定哪些模型可用
- 防止意外使用错误的模型

### 2. 灵活性
- 支持API获取 + 手动添加
- 适应各种使用场景

### 3. 健壮性
- 防止API返回不完整的模型列表
- 支持测试新模型

### 4. 清晰的状态管理
- 明确区分"可用"和"已启用"
- 标记手动添加的模型

## 注意事项

1. **首次使用**：新添加的服务商默认没有启用任何模型，需要用户主动管理
2. **模型删除**：删除模型会从数据库中永久删除，谨慎操作
3. **API获取**：某些服务商可能需要特定权限才能获取模型列表
4. **模型名称**：手动添加时确保模型名称准确，否则可能无法使用

## 未来扩展

可以考虑的功能：
- 模型分组管理
- 模型使用统计
- 模型收藏功能
- 批量启用/禁用
- 模型搜索功能

---

**更新时间**：2025年11月2日  
**版本**：2.0
